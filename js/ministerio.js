// Dados das músicas para a Missa de Ação de Graças
const musicData = [
    {
        moment: "Entrada",
        icon: "fas fa-door-open",
        songs: [
            {
                title: "É CHEGADO O TEMPO",
                key: "D",
                lyrics: `[Intro] D9  D9/F#  G9  G7M  Gm7 

D9            A/C#   Bm                    A 
   É chegado o tempo     de se olhar por dentro 
G9       G7M    D9/F#   G9   G7M  A4 
Tempo de se esvaziar,   de   recomeçar 
G9              D9/F#          G9  A 
Tempo da graça, tempo de acreditar 

D9                A/C#   Bm                   D9/F# 
   Eis o tempo da espera     onde o brilho da estrela 
G9         D9/F#  G9/E   A4 
Vem nos preparar, nos anunciar 
G9      G7M   G9/E      A4     A11 
Está chegando o      Emanuel 

D9              A/C#               G9 
Ele virá, nos trará sua paz e sua luz 
 G7M  G9/E       A4 
Iluminará nossas vidas 
 D9              A/C#               G9 
Cristo Jesus salvador reinará sobre nós e assim 
    G9/E       A4 
Cantaremos sua glória! 
D9              A/C#               G9 
Ele virá, nos trará sua paz e sua luz 
 G7M  G9/E       A4 
Iluminará nossas vidas 
D9              A/C#                G9 
Cristo Jesus salvador reinará sobre nós e assim 

    G7M           Bm   A   G9 
Cantaremos sua glória! 
    G7M           Bm   A   G9 
Cantaremos sua glória! 
                  Bm 
Cantaremos sua glória!`
            }
        ]
    },
    {
        moment: "Ato Penitencial",
        icon: "fas fa-hands-praying",
        songs: [
            {
                title: "KYRIE ELEISON",
                key: "D",
                lyrics: `[Intro] D  Em  Bm  A 
        D  Em  Bm  A4 

[Primeira Parte] 
    D 
Senhor que viestes 
     Bm7 
Não para condenar 
     G7M     D/F# 
Mas para perdoar 
 Em      Bm    A/C#  ( G/B  A ) 
Tende piedade de nós 

[Refrão] 
D Em7  D/F# G 
Kyrie Eleison 
D Em7 D/F# G 
Kyrie Eleison 
   Bm   A4 A D  G/D 
Kyrie Eleison 

[Segunda Parte] 
 D 
Cristo que vos alegrais 
 Bm7          G7M    D/F# 
Pelo pecador arrependido 
Em        Bm     A/C#   ( G/B  A ) 
Tende piedade de nós 

[Refrão] 
D   Em7  D/F# G 
Christe Eleison 
D  Em7 D/F# G 
Christe Eleison 
   Bm   A4 A D  G/D 
Christe Eleison 

[Terceira Parte] 
    D 
Senhor que muito perdoais 
Bm            G7M      D/F# 
A todo aquele que muito ama 
Em       Bm     A/C#  ( G/B  A ) 
Tende piedade de nós 

[Refrão] 
D Em7  D/F# G 
Kyrie Eleison 
D Em7 D/F# G 
Kyrie Eleison 
   Bm   A4 A D 
Kyrie Eleison`
            }
        ]
    },
    {
        moment: "Salmo",
        icon: "fas fa-book-bible",
        songs: [
            {
                title: "NOS SEUS DIAS A JUSTIÇA FLORIRÁ",
                key: "D",
                lyrics: `G/B A/C#    D         G/B      A/C# 
Nos seus dias a justiça florirá. 
A/G         D/F#        Em7     Asus 
Nos seus dias a justiça florirá. 

          Em7                                         A4 
Dai ao Rei vossos poderes, Senhor Deus, 
              Em7                                       A4 Bm7 
vossa justiça ao descendente da realeza! 
            Em   D/F# G         E/G#   A4 
Com justiça ele governe o vosso povo, 

                Em7                   A4 
Nos seus dias a justiça florirá 
               Em7                                       A4  Bm7 
e grande paz, até que a lua perca o brilho! 
               Em     D/F#    G   E/G#  A4 
De mar a mar estenderá o seu domínio, 

          Em7                              A4 
Libertará o indigente que suplica, * 
     Em7                                            A4 Bm7 
e o pobre ao qual ninguém quer ajudar. 
       Em    D/F#  G         E/G#    A4 
Terá pena do indigente e do infeliz, 

              Em7                                 A4 
Seja bendito o seu nome para sempre! * 
          Em7                                    A4 Bm7 
E que dure como o sol sua memória! 
              Em       D/F# G      E/G#     A4 
Todos os povos serão nele abençoados,`
            }
        ]
    },
    {
        moment: "Aclamação",
        icon: "fas fa-music",
        songs: [
            {
                title: "ALELUIA",
                key: "F#m",
                lyrics: `    E         F#m 
Aleluia, aleluia! 
    E         F#m 
Aleluia, aleluia! 

        Bm        A     Bm 
O Espírito consagrou-me 
      D     E    F#m 
E mandou-me anunciar 
 Bm      F#m    C#7  F#m 
Boa nova para os pobres!`
            }
        ]
    },
    {
        moment: "Ofertório",
        icon: "fas fa-gift",
        songs: [
            {
                title: "Ó SANTO MESSIAS",
                key: "Em",
                lyrics: `[Intro] Em  Bm  Em  Bm  C  D  Em 

      Em       Bm       Em 
Solo: muito suspira por ti 
    Bm     Em  Bm      Em 
Teu povo fiel, tua israel! 
            Am       Bm       C 
Assembleia: muito suspira por ti 
    D      C   Bm      Em 
Teu povo fiel, tua israel! 

        F#m7(5-) B7     C    G/B 
Solo: ó san  -  nto messias! 
              Am B7     Em 
Assembleia: ó santo messias! 

      Em       Bm        Em 
Solo: tua lembrança embalsama 
Bm         Em   Bm         Em 
Dos que te amam os tristes dias 
            Am       Bm        C 
Assembleia: tua lembrança embalsama 
D          C    Bm         Em 
Dos que te amam os tristes dias 

        F#m7(5-) B7     C    G/B 
Solo: ó san  -  nto messias! 
              Am B7     Em 
Assembleia: ó santo messias! 

      Em      Bm        Em 
Solo: a nação que te adorava 
   Bm         Em       Bm           Em 
Tornaram-na escrava, encheram-na de dor 
            Am      Bm        C 
Assembleia: a nação que te adorava 
   D          C        Bm           Em 
Tornaram-na escrava, encheram-na de dor 

        F#m7(5-) B7     C    G/B 
Solo: ó san  -  nto messias! 
              Am B7     Em 
Assembleia: ó santo messias! 

       F#m5-        Em       B      C 
Solo: apressa-te em vir libertá-la,  
    Am 
em vir salvá-la 
   Bm    Em     Bm    E 
Bendito senhor! Bendito senhor!`
            }
        ]
    },
    {
        moment: "Santo",
        icon: "fas fa-church",
        songs: [
            {
                title: "SANTO É O SENHOR",
                key: "G",
                lyrics: `Intro.:    Em    D    C    G/B     Am     
Am/G    F#m7(b5)   B4    B 

Em  D   C   G  D  Em   F      C/E     D4  
San------to, San----to, Santo é o Senhor 
D#dim 

Em  D   C   G  D    Em F      C/E     D4  
San------to, San----to, Santo é o Senhor 
Dadd9 

Am7(9)       Bm7(9)              C 
Céus e terra proclamam vossa glória 
  F#m7(b5)      B7add9  Fadd9 
Hosana nas alturas 

Em  D   C   G  D  Em   F      C/E     D4  
San------to, San----to, Santo é o Senhor 
D#dim 

Em  D   C   G  D    Em F      C/E     D4  
San------to, San----to, Santo é o Senhor 
Dadd9 

Am7(9)             Bm7            C 
Bendito o que vem em nome do Senhor 
  F#m7(b5)      B7  Cdim  C#7 
Hosana nas alturas 

F#m   E  D  A E  F#m  G     D/F#    E4 Fdim 
San------to, Santo,   Santo é o Senhor 
F#m   E  D  A E  F#m  G     D/F#    E4 E 
San------to, Santo,   Santo é o Senhor`
            }
        ]
    },
    {
        moment: "Comunhão",
        icon: "fas fa-wine-glass-alt",
        songs: [
            {
                title: "DA CEPA BROTOU A RAMA",
                key: "Dm",
                lyrics: `[Intro] Dm  Gm  A7  Dm 

[Refrão] 
    Dm            A7 
Da cepa brotou a rama 
                   Dm 
Da rama brotou a flor 
     D            Gm 
Da flor nasceu Maria 
      Dm     A7   Dm 
De Maria, o Salvador 

    Dm            A7 
Da cepa brotou a rama 
                   Dm 
Da rama brotou a flor 
     D            Gm 
Da flor nasceu Maria 
      Dm     A7   Dm 
De Maria, o Salvador 

[Primeira Parte] 
     Gm        C7 
O Espírito de Deus 
      F         A# 
Sobre ele pousará 
      Em7(5-)       A7 
De saber, de entendimento 
                 Dm 
Este Espírito será 

       Gm           C7 
De conselho e fortaleza 
     F             A# 
De ciência e de temor 
     Em7(5-)   A7 
Achará sua alegria 
                    Dm 
No temor do seu Senhor 

[Refrão] 
    Dm            A7 
Da cepa brotou a rama 
                   Dm 
Da rama brotou a flor 
     D            Gm 
Da flor nasceu Maria 
      Dm     A7   Dm 
De Maria, o Salvador 

    Dm            A7 
Da cepa brotou a rama 
                   Dm 
Da rama brotou a flor 
     D            Gm 
Da flor nasceu Maria 
      Dm     A7   Dm 
De Maria, o Salvador 

[Segunda Parte] 
       Gm         C7 
Não será pela ilusão 
      F               A# 
Do olhar, do ouvir falar 
          Em7(5-)     A7 
Que ele irá julgar os homens 
                  Dm 
Como é praxe acontecer 

        Gm           C7 
Mas os pobres desta terra 
        F         A# 
Com justiça julgará 
        Em7(5-)  A7 
E dos fracos o direito 
                   Dm 
Ele é quem defenderá 

[Refrão] 
    Dm            A7 
Da cepa brotou a rama 
                   Dm 
Da rama brotou a flor 
     D            Gm 
Da flor nasceu Maria 
      Dm     A7   Dm 
De Maria, o Salvador 

    Dm            A7 
Da cepa brotou a rama 
                   Dm 
Da rama brotou a flor 
     D            Gm 
Da flor nasceu Maria 
      Dm     A7   Dm 
De Maria, o Salvador 

[Terceira Parte] 
     Gm           C7 
A palavra de sua boca 
     F       A# 
Ferirá o violento 
     Em7(5-)      A7 
E o sopro de seus lábios 
             Dm 
Matará o avarento 

      Gm       C7 
A justiça é o cinto 
        F              A# 
Que circunda a sua cintura 
     Em7(5-)     A7 
E o manto da lealdade 
              Dm 
É a sua vestidura 

[Refrão] 
    Dm            A7 
Da cepa brotou a rama 
                   Dm 
Da rama brotou a flor 
     D            Gm 
Da flor nasceu Maria 
      Dm     A7   Dm 
De Maria, o Salvador 

    Dm            A7 
Da cepa brotou a rama 
                   Dm 
Da rama brotou a flor 
     D            Gm 
Da flor nasceu Maria 
      Dm     A7   Dm 
De Maria, o Salvador 

[Quarta Parte] 
       Gm         C7 
Neste dia, neste dia 
      F           A# 
O incrível, verdadeiro 
        Em7(5-)    A7 
Coisa que nunca se viu 
                   Dm 
Morar lobo com cordeiro 

     Gm           C7 
A comer do mesmo pasto 
         F             A# 
Tigre e boi, burro e leão 
        Em7(5-)  A7 
Por um menino  guiados 
                 Dm 
Se confraternizarão 

[Refrão] 
    Dm            A7 
Da cepa brotou a rama 
                   Dm 
Da rama brotou a flor 
     D            Gm 
Da flor nasceu Maria 
      Dm     A7   Dm 
De Maria, o Salvador 

    Dm            A7 
Da cepa brotou a rama 
                   Dm 
Da rama brotou a flor 
     D            Gm 
Da flor nasceu Maria 
      Dm     A7   Dm 
De Maria, o Salvador`
            }
        ]
    },
    {
        moment: "Pós-Comunhão",
        icon: "fas fa-praying-hands",
        songs: [
            {
                title: "UMA GRANDE MISSÃO",
                key: "C",
                lyrics: `    C                       Am 
Um dia, como qualquer outro dia 
              F    G                 C 
O Senhor me criou para uma grande  
   G7 
missão 
       C                       Am 
Um jovem, como qualquer outro jovem 
              F    G                  C 
O Senhor me chamou para uma grande missão 

F  G        C  F    G         C 
Eu nada sabia, eu nada entendia 
F  G         C   G                C 
Eu nada previa de uma grande missão 
F  G          C  F    G     C 
Eu me encantei, me apaixonei 
F  G        C  Am   Dm     G        C 
O barco larguei    por uma grande missão 

F         G          C  F         G 
Eu disse sim, ó Senhor! Eu disse  
       C 
sim por amor 
F         G         C     G          
Pronto pra ir eu estou para uma  
        C 
grande missão 
F         G        C   F          G 
Eu disse sim, ó Senhor! Eu disse  
       C 
sim por amor 
F          G       C  Am  Dm        
Pronto pra ir eu estou   para uma  
G         C  (G) 
nova missão 

    C                          Am 
Um mundo, como qualquer outro mundo 
              F    G                   
O Senhor me elegeu para uma grande  
C   G 
missão 
    C                       Am 
Um povo, como qualquer outro povo 
              F    G                 C 
O Senhor me enviou para uma grande missão 

F   G        C  F    G      C 
Eu não resisti, eu quase morri 
F   G        C  G                  C 
Chorei e sorri por uma grande missão 
F  G           C  F  G         C 
A vida arrisquei, eu tudo deixei 
F    G       C  Am  Dm       G     C 
E a cruz carreguei por uma grande missão`
            }
        ]
    },
    {
        moment: "Final",
        icon: "fas fa-flag",
        songs: [
            {
                title: "VIGIA ESPERANDO A AURORA",
                key: "D",
                lyrics: `[Intro] D  G  F#m7 Em7  
        D  G  F#m7 Em7  
        D  A4  A 

[Refrão] 
   D     G           D        
Vigia esperando a aurora  
              G          D  D7 
Qual noiva esperando o amor 
     G         F#m7    Bm7     
É assim que o servo espera  
   Em7   A         D  Em7  D/F# 
A vinda do seu Senhor 
     G         F#m7    Bm7     
É assim que o servo espera  
   Em7   A         D 
A vinda do seu Senhor 

[Primeira Parte] 
              A        A/G        D 
Ao longe, um galo vai cantar seu canto 
          B         B/D#       Em7 
O sol no céu vai estender seu manto 
         G         A        D 
Na madrugada eu estarei desperto 
            E        E/G#     A  G  F#m7 Em7 
Que já vem perto o dia do Senhor! 

[Refrão] 
   D     G           D        
Vigia esperando a aurora  
              G          D  D7 
Qual noiva esperando o amor 
     G         F#m7    Bm7     
É assim que o servo espera  
   Em7   A         D  Em7  D/F# 
A vinda do seu Senhor 
     G         F#m7    Bm7     
É assim que o servo espera  
   Em7   A         D 
A vinda do seu Senhor 

[Segunda Parte] 
         A        A/G        D 
A minha voz vai acordar meu povo 
            B           B/D#      Em7 
Louvando a Deus que faz um mundo novo 
           G           A         D 
Não vou ligar se a madrugada é fria 
             E     E/G#      A  G  F#m7 Em7 
Que um novo dia logo vai chegar 

[Refrão] 
   D       G         D        
Vigia esperando a aurora  
                G        D  D7 
Qual noiva esperando o amor 
     G         F#m7    Bm7     
É assim que o servo espera  
   Em7      A      D  Em7  D/F# 
A vinda do seu Senhor 
     G         F#m7    Bm7     
É assim que o servo espera  
   Em7      A      D 
A vinda do seu Senhor 

( A  G  D ) 
( A  G  D ) 
( E  E/G#  A ) 
( G  F#m7 Em7  D/F# ) 

[Terceira Parte] 
              A           A/G      D 
Se é noite escura, acendo a minha tocha 
           B           B/D#    Em7 
Dentro do peito o sol já desabrocha 
          G               A      D 
Filho da luz, não vou dormir, vigio 
           E         E/G#   A  G  F#m7 Em7 
Ao mundo frio vou levar o amor! 

[Refrão] 
   D       G         D        
Vigia esperando a aurora  
                G        D  D7 
Qual noiva esperando o amor 
     G         F#m7    Bm7     
É assim que o servo espera  
   Em7      A      D  Em7  D/F# 
A vinda do seu Senhor 
     G         F#m7    Bm7     
É assim que o servo espera  
   Em7      A      D 
A vinda do seu Senhor`
            }
        ]
    }
];

// Função para criar links da liturgia
function createLiturgyLinks() {
    const liturgyContainer = document.getElementById('liturgy-links');
    liturgyContainer.innerHTML = '';

    musicData.forEach((moment, index) => {
        const link = document.createElement('a');
        link.className = 'liturgy-link';
        link.href = `#moment-${index}`;
        link.innerHTML = `
                <i class="${moment.icon}"></i>
                <span>${moment.moment}</span>
            `;

        link.addEventListener('click', function(e) {
            e.preventDefault();
            const targetSection = document.getElementById(`moment-${index}`);
            if (targetSection) {
                // Expande a seção
                const content = targetSection.querySelector('.moment-content');
                content.classList.add('expanded');
                const arrow = targetSection.querySelector('.moment-arrow');
                arrow.textContent = '▲';

                // Rola suavemente até a seção
                targetSection.scrollIntoView({
                    behavior: 'smooth',
                    block: 'start'
                });
            }
        });

        liturgyContainer.appendChild(link);
    });
}

// Função para renderizar as músicas
function renderMusicList() {
    const musicListContainer = document.getElementById('music-list');
    musicListContainer.innerHTML = '';

    musicData.forEach((moment, momentIndex) => {
        const momentSection = document.createElement('div');
        momentSection.className = 'moment-section';
        momentSection.id = `moment-${momentIndex}`;

        const momentHeader = document.createElement('div');
        momentHeader.className = 'moment-header';
        momentHeader.innerHTML = `
                <h2><i class="${moment.icon} moment-icon"></i> ${moment.moment}</h2>
                <span class="moment-arrow">▼</span>
            `;

        const momentContent = document.createElement('div');
        momentContent.className = 'moment-content';

        moment.songs.forEach((song, songIndex) => {
            const songItem = document.createElement('div');
            songItem.className = 'song-item';
            songItem.innerHTML = `
                    <div class="song-title">
                        <span>${song.title}</span>
                        <span class="song-key">${song.key}</span>
                    </div>
                    <div class="song-lyrics">${formatLyrics(song.lyrics)}</div>
                    <button class="back-to-liturgy" onclick="scrollToLiturgy()">
                        <i class="fas fa-arrow-left"></i> Voltar para a Liturgia
                    </button>
                `;

            momentContent.appendChild(songItem);
        });

        // Adicionar evento de clique para expandir/contrair o momento
        momentHeader.addEventListener('click', function() {
            momentContent.classList.toggle('expanded');
            const arrow = this.querySelector('.moment-arrow');
            arrow.textContent = momentContent.classList.contains('expanded') ? '▲' : '▼';
        });

        momentSection.appendChild(momentHeader);
        momentSection.appendChild(momentContent);
        musicListContainer.appendChild(momentSection);
    });
}

// Função para rolar até a liturgia
function scrollToLiturgy() {
    const liturgySection = document.querySelector('.liturgy-section');
    if (liturgySection) {
        liturgySection.scrollIntoView({
            behavior: 'smooth',
            block: 'start'
        });

        // Expande a liturgia
        const liturgyContent = document.querySelector('.liturgy-content');
        liturgyContent.classList.add('expanded');
        const liturgyArrow = document.querySelector('.liturgy-arrow');
        liturgyArrow.textContent = '▲';
    }
}

// Função para tornar a liturgia expansível
function setupLiturgyExpansion() {
    const liturgyHeader = document.querySelector('.liturgy-header');
    const liturgyContent = document.querySelector('.liturgy-content');
    const liturgyArrow = document.querySelector('.liturgy-arrow');

    liturgyHeader.addEventListener('click', function() {
        liturgyContent.classList.toggle('expanded');
        liturgyArrow.textContent = liturgyContent.classList.contains('expanded') ? '▲' : '▼';
    });
}

// Função para formatar acordes nas letras
function formatLyrics(lyrics) {
    // Destacar acordes entre colchetes
    return lyrics.replace(/\[(.*?)\]/g, '<span class="chord">[$1]</span>');
}

// Funções para controle de fonte
function increaseFontSize() {
    const root = document.documentElement;
    let currentSize = parseFloat(getComputedStyle(root).getPropertyValue('--font-size'));
    if (currentSize < 22) {
        root.style.setProperty('--font-size', (currentSize + 1) + 'px');
    }
}

function decreaseFontSize() {
    const root = document.documentElement;
    let currentSize = parseFloat(getComputedStyle(root).getPropertyValue('--font-size'));
    if (currentSize > 12) {
        root.style.setProperty('--font-size', (currentSize - 1) + 'px');
    }
}

function resetFontSize() {
    document.documentElement.style.setProperty('--font-size', '16px');
}

// Função para expandir/recolher todas as seções
function expandAll() {
    document.querySelectorAll('.moment-content').forEach(content => {
        content.classList.add('expanded');
    });
    document.querySelectorAll('.moment-arrow').forEach(arrow => {
        arrow.textContent = '▲';
    });
    document.querySelector('.liturgy-content').classList.add('expanded');
    document.querySelector('.liturgy-arrow').textContent = '▲';
}

function collapseAll() {
    document.querySelectorAll('.moment-content').forEach(content => {
        content.classList.remove('expanded');
    });
    document.querySelectorAll('.moment-arrow').forEach(arrow => {
        arrow.textContent = '▼';
    });
    document.querySelector('.liturgy-content').classList.remove('expanded');
    document.querySelector('.liturgy-arrow').textContent = '▼';
}

// Função de busca
function setupSearch() {
    const searchInput = document.getElementById('search-input');
    searchInput.addEventListener('input', function() {
        const searchTerm = this.value.toLowerCase();

        document.querySelectorAll('.moment-section').forEach(section => {
            const momentHeader = section.querySelector('.moment-header h2').textContent.toLowerCase();
            const songs = section.querySelectorAll('.song-item');
            let hasMatch = false;

            songs.forEach(song => {
                const title = song.querySelector('.song-title span').textContent.toLowerCase();
                const lyrics = song.querySelector('.song-lyrics').textContent.toLowerCase();

                if (title.includes(searchTerm) || lyrics.includes(searchTerm)) {
                    song.style.display = 'block';
                    hasMatch = true;
                } else {
                    song.style.display = 'none';
                }
            });

            // Mostrar/ocultar seção baseado nos resultados
            section.style.display = hasMatch || momentHeader.includes(searchTerm) ? 'block' : 'none';
        });
    });
}

// ============================================================================
// NOVA FUNCIONALIDADE: Buscar Liturgia da Canção Nova usando API Fetch
// ============================================================================

// Função principal para buscar a liturgia
async function fetchLiturgia() {
    try {
        // Obter parâmetros da URL ou usar data atual
        const urlParams = new URLSearchParams(window.location.search);
        let day = urlParams.get('dia');
        let month = urlParams.get('mes');
        let year = urlParams.get('ano');
        
        const today = new Date();
        if (!day) day = today.getDate();
        if (!month) month = today.getMonth() + 1;
        if (!year) year = today.getFullYear();
        
        // Formatar datas
        const formattedDay = day.toString().padStart(2, '0');
        const formattedMonth = month.toString().padStart(2, '0');
        
        console.log(`Buscando liturgia para: ${formattedDay}/${formattedMonth}/${year}`);
        
        // Primeiro, tentar buscar a página completa usando um proxy mais confiável
        const liturgiaData = await fetchLiturgiaFromCN(formattedDay, formattedMonth, year);
        
        if (liturgiaData && (liturgiaData.primeiraLeitura.texto || liturgiaData.evangelho.texto)) {
            // Dados obtidos com sucesso
            formatAndDisplayLiturgia(liturgiaData, formattedDay, formattedMonth, year);
        } else {
            // Fallback: mostrar mensagem e manter controles
            showLiturgiaError(formattedDay, formattedMonth, year);
        }
        
    } catch (error) {
        console.error('Erro ao buscar liturgia:', error);
        showLiturgiaError();
    }
}

// Nova função usando fetch direto (sem proxy complicado)
async function fetchLiturgiaFromCN(day, month, year) {
    try {
        // Tentar uma abordagem diferente: usar o iframe ou embed
        const url = `https://liturgia.cancaonova.com/pb/liturgia/?sDia=${day}&sMes=${month}&sAno=${year}`;
        
        // Usar um serviço de proxy mais simples
        const proxyUrl = `https://corsproxy.io/?${encodeURIComponent(url)}`;
        
        const response = await fetch(proxyUrl, {
            headers: {
                'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
            }
        });
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const html = await response.text();
        
        // Analisar o HTML
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, 'text/html');
        
        return extractLiturgiaFromHTML(doc);
        
    } catch (error) {
        console.error('Erro na busca direta:', error);
        // Tentar método alternativo
        return await fetchLiturgiaAlternative(day, month, year);
    }
}

// Função melhorada para extrair dados do HTML
function extractLiturgiaFromHTML(doc) {
    const data = {
        titulo: '',
        corLiturgica: '',
        primeiraLeitura: { titulo: '', texto: '' },
        salmo: { titulo: '', texto: '', refrao: '' },
        evangelho: { titulo: '', texto: '' },
        cor: 'verde'
    };
    
    try {
        // Extrair título
        const tituloElement = doc.querySelector('.entry-title');
        if (tituloElement) {
            data.titulo = tituloElement.textContent.trim();
        }
        
        // Extrair cor litúrgica
        const corElement = doc.querySelector('.cor-liturgica');
        if (corElement) {
            const corText = corElement.textContent.trim();
            const corMatch = corText.match(/Cor Litúrgica:\s*(.+)/i);
            if (corMatch) {
                data.corLiturgica = corText;
                data.cor = corMatch[1].trim();
            }
        }
        
        // Método robusto: buscar por texto em todo o documento
        const fullText = doc.body.textContent || doc.body.innerText;
        
        // Buscar Primeira Leitura
        const primeiraMatch = fullText.match(/Primeira Leitura\s*\(([^)]+)\)([\s\S]*?)(?=Palavra do Senhor|Salmo|Evangelho|Responsório)/i);
        if (primeiraMatch) {
            data.primeiraLeitura.titulo = `PRIMEIRA LEITURA (${primeiraMatch[1].trim()})`;
            data.primeiraLeitura.texto = primeiraMatch[2].trim();
        }
        
        // Buscar Salmo/Responsório
        const salmoMatch = fullText.match(/(Responsório|Salmo)[\s\S]*?\(([^)]+)\)([\s\S]*?)(?=R\.|Evangelho|Segunda Leitura)/i);
        if (salmoMatch) {
            data.salmo.titulo = `${salmoMatch[1].toUpperCase()} (${salmoMatch[2].trim()})`;
            let salmoTexto = salmoMatch[3].trim();
            
            // Extrair refrão
            const refraoMatch = salmoTexto.match(/-\s*(.+?)(?=\n|$)/);
            if (refraoMatch) {
                data.salmo.refrao = refraoMatch[1].trim();
            }
            
            data.salmo.texto = salmoTexto;
        }
        
        // Buscar Evangelho
        const evangelhoMatch = fullText.match(/Evangelho\s*\(([^)]+)\)([\s\S]*?)(?=Palavra da Salvação|Ritos|Liturgia|Oração)/i);
        if (evangelhoMatch) {
            data.evangelho.titulo = `EVANGELHO (${evangelhoMatch[1].trim()})`;
            data.evangelho.texto = evangelhoMatch[2].trim();
        }
        
        // Se não encontrou por regex, tentar buscar elementos específicos
        if (!data.primeiraLeitura.texto) {
            const tabContent = doc.querySelector('.tab-content');
            if (tabContent) {
                const panes = tabContent.querySelectorAll('.tab-pane');
                panes.forEach(pane => {
                    const paneText = pane.textContent || pane.innerText;
                    if (paneText.includes('Primeira Leitura')) {
                        data.primeiraLeitura.texto = paneText.replace(/Primeira Leitura\s*\([^)]+\)/i, '')
                                                              .replace(/Palavra do Senhor.*/i, '')
                                                              .trim();
                    } else if (paneText.includes('Salmo') || paneText.includes('Responsório')) {
                        data.salmo.texto = paneText.replace(/(Responsório|Salmo)[\s\S]*?\([^)]+\)/i, '').trim();
                    } else if (paneText.includes('Evangelho')) {
                        data.evangelho.texto = paneText.replace(/Evangelho\s*\([^)]+\)/i, '')
                                                        .replace(/Palavra da Salvação.*/i, '')
                                                        .trim();
                    }
                });
            }
        }
        
    } catch (error) {
        console.error('Erro na extração:', error);
    }
    
    return data;
}

// Método alternativo: usar iframe embutido
async function fetchLiturgiaAlternative(day, month, year) {
    // Esta função pode ser expandida para usar outras fontes
    // Por enquanto, retorna dados vazios para o fallback
    return null;
}

// Função para formatar e exibir a liturgia
function formatAndDisplayLiturgia(liturgiaData, day, month, year) {
    const liturgyContent = document.querySelector('.liturgy-content');
    if (!liturgyContent) return;
    
    // Mapear cores litúrgicas
    const colorMap = {
        'verde': '#228B22',
        'roxo': '#800080', 
        'branco': '#FFFFFF',
        'vermelho': '#DC143C',
        'rosa': '#FF69B4',
        'dourado': '#FFD700',
        'azul': '#1E90FF'
    };
    
    // Atualizar cores CSS
    const corLower = (liturgiaData.cor || 'verde').toLowerCase();
    if (colorMap[corLower]) {
        document.documentElement.style.setProperty('--primary', colorMap[corLower]);
        document.documentElement.style.setProperty('--liturgical-color', colorMap[corLower]);
    }
    
    // Formatar data
    const meses = ['Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho', 
                  'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
    const dataFormatada = `${parseInt(day)} de ${meses[parseInt(month)-1]} de ${year}`;
    
    // Verificar se temos leituras
    const hasReadings = liturgiaData.primeiraLeitura.texto || liturgiaData.salmo.texto || liturgiaData.evangelho.texto;
    
    // Criar conteúdo HTML
    let html = `
        <strong>LITURGIA DO DIA</strong><br><br>
        
        <strong>${liturgiaData.titulo || 'Liturgia Diária'}</strong><br>
        ${dataFormatada}<br>
        (Cor litúrgica: ${liturgiaData.cor || 'verde'})<br><br>
        
        <strong>RITOS INICIAIS</strong><br><br>
        
        <span class="liturgy-role">Sacerdote:</span> Em nome do Pai, do Filho ✠ e do Espírito Santo.<br>
        <span class="liturgy-response">Amém.</span><br><br>
        
        <span class="liturgy-role">Sacerdote:</span> A graça de nosso Senhor Jesus Cristo, o amor do Pai e a comunhão do Espírito Santo estejam convosco.<br>
        <span class="liturgy-response">Bendito seja Deus, que nos reuniu no amor de Cristo!</span><br><br>
    `;
    
    // Adicionar Primeira Leitura
    if (liturgiaData.primeiraLeitura.texto) {
        html += `
            <div class="liturgy-reading">
                <div class="liturgy-reading-title">${liturgiaData.primeiraLeitura.titulo || 'PRIMEIRA LEITURA'}</div>
                ${formatReadingText(liturgiaData.primeiraLeitura.texto)}<br><br>
                <span class="liturgy-role">Leitor:</span> Palavra do Senhor.<br>
                <span class="liturgy-response">Graças a Deus.</span>
            </div><br>
        `;
    } else if (!hasReadings) {
        html += `
            <div class="liturgy-reading">
                <div class="liturgy-reading-title">PRIMEIRA LEITURA</div>
                <em>Leitura não disponível automaticamente.</em><br><br>
                <span class="liturgy-role">Leitor:</span> Palavra do Senhor.<br>
                <span class="liturgy-response">Graças a Deus.</span>
            </div><br>
        `;
    }
    
    // Adicionar Salmo
    if (liturgiaData.salmo.texto) {
        html += `
            <div class="liturgy-reading">
                <div class="liturgy-reading-title">${liturgiaData.salmo.titulo || 'SALMO RESPONSORIAL'}</div>
                ${liturgiaData.salmo.refrao ? 
                    `<span class="liturgy-role">R.</span> <span class="liturgy-response">${liturgiaData.salmo.refrao}</span><br><br>` : 
                    ''}
                ${formatPsalmText(liturgiaData.salmo.texto, liturgiaData.salmo.refrao)}
            </div><br>
        `;
    } else if (!hasReadings) {
        html += `
            <div class="liturgy-reading">
                <div class="liturgy-reading-title">SALMO RESPONSORIAL</div>
                <em>Salmo não disponível automaticamente.</em>
            </div><br>
        `;
    }
    
    // Adicionar Evangelho
    if (liturgiaData.evangelho.texto) {
        html += `
            <div class="liturgy-reading">
                <div class="liturgy-reading-title">${liturgiaData.evangelho.titulo || 'EVANGELHO'}</div>
                <span class="liturgy-role">Aclamação:</span> Aleluia, Aleluia, Aleluia.<br>
                <span class="liturgy-role">V.</span> Preparai o caminho do Senhor, endireitai suas veredas!<br><br>
                
                Proclamação do Evangelho de Jesus Cristo.<br><br>
                
                <span class="liturgy-role">Sacerdote:</span> O Senhor esteja convosco.<br>
                <span class="liturgy-response">Ele está no meio de nós.</span><br><br>
                
                ${formatReadingText(liturgiaData.evangelho.texto)}<br><br>
                
                <span class="liturgy-role">Sacerdote:</span> Palavra da Salvação.<br>
                <span class="liturgy-response">Glória a vós, Senhor.</span>
            </div><br>
        `;
    } else if (!hasReadings) {
        html += `
            <div class="liturgy-reading">
                <div class="liturgy-reading-title">EVANGELHO</div>
                <em>Evangelho não disponível automaticamente.</em><br><br>
                <span class="liturgy-role">Sacerdote:</span> Palavra da Salvação.<br>
                <span class="liturgy-response">Glória a vós, Senhor.</span>
            </div><br>
        `;
    }
    
    // Adicionar partes fixas
    html += `
        <strong>LITURGIA EUCARÍSTICA</strong><br><br>
        
        <span class="liturgy-role">Oração sobre as oferendas:</span> Aceitai, ó Deus, as oferendas que vos apresentamos. Fazei que esta Eucaristia seja para nós fonte de graça e renovação. Por Cristo, nosso Senhor.<br>
        <span class="liturgy-response">Amém.</span><br><br>
        
        <strong>RITOS FINAIS</strong><br><br>
        
        <span class="liturgy-role">Oração após a comunhão:</span> Deus eterno e todo-poderoso, que nos alimentastes com o pão da vida, fazei que nosso coração se encha de vossa graça. Por Cristo, nosso Senhor.<br>
        <span class="liturgy-response">Amém.</span><br><br>
        
        <span class="liturgy-role">Bênção solene:</span> O Deus, que nos reuniu nesta celebração, vos abençoe e guarde. ✠ Amém.<br>
        Que Ele ilumine o vosso caminho e fortaleça vossa fé. ✠ Amém.<br>
        E que todos nós, aqui reunidos, sejamos testemunhas do seu amor. ✠ Amém.<br><br>
        
        <span class="liturgy-role">Sacerdote:</span> E a bênção de Deus todo-poderoso, Pai, Filho e Espírito Santo, desça sobre vós e permaneça para sempre.<br>
        <span class="liturgy-response">Amém.</span><br><br>
        
        <span class="liturgy-role">Sacerdote:</span> Ide em paz, levando a alegria desta celebração!<br>
        <span class="liturgy-response">Graças a Deus!</span>
    `;
    
    // Adicionar link para site oficial
    html += `
        <div style="margin-top: 20px; padding: 10px; background: var(--light); border-left: 4px solid var(--primary); border-radius: 4px; font-size: 0.9em;">
            <i class="fas fa-external-link-alt"></i> 
            <strong>Para as leituras completas:</strong> 
            <a href="https://liturgia.cancaonova.com/pb/liturgia/?sDia=${day}&sMes=${month}&sAno=${year}" target="_blank" style="color: var(--primary);">
                Acesse o site oficial da Canção Nova
            </a>
        </div>
    `;
    
    // Inserir conteúdo
    liturgyContent.innerHTML = html;
    
    // Atualizar título
    const liturgyHeader = document.querySelector('.liturgy-header h2');
    if (liturgyHeader) {
        liturgyHeader.innerHTML = `<i class="fas fa-book-bible liturgy-icon"></i> Liturgia - ${dataFormatada}`;
    }
    
    // Adicionar controles
    addLiturgyControls(day, month, year);
}

// Funções auxiliares
function formatReadingText(text) {
    return text.replace(/\.\s/g, '.<br>')
               .replace(/\n/g, '<br>')
               .replace(/\s\s+/g, ' ');
}

function formatPsalmText(text, refrao) {
    let formatted = text;
    if (refrao) {
        // Adicionar refrão após cada estrofe
        const verses = text.split(/\n+/);
        formatted = '';
        verses.forEach((verse, index) => {
            if (verse.trim()) {
                formatted += verse.trim() + '<br>';
                if (index < verses.length - 1) {
                    formatted += `<span class="liturgy-role">R.</span> <span class="liturgy-response">${refrao}</span><br><br>`;
                }
            }
        });
    }
    return formatted;
}

// Função para mostrar erro
function showLiturgiaError(day, month, year) {
    const liturgyContent = document.querySelector('.liturgy-content');
    if (!liturgyContent) return;
    
    const meses = ['Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho', 
                  'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
    const dataFormatada = `${parseInt(day)} de ${meses[parseInt(month)-1]} de ${year}`;
    
    liturgyContent.innerHTML = `
        <strong>LITURGIA DO DIA</strong><br><br>
        
        <strong>Liturgia Diária</strong><br>
        ${dataFormatada}<br>
        (Cor litúrgica: verde)<br><br>
        
        <div style="background: #fff3cd; padding: 15px; border-left: 4px solid #ffc107; margin: 10px 0; border-radius: 4px;">
            <i class="fas fa-info-circle"></i> <strong>Informação:</strong><br>
            As leituras não puderam ser carregadas automaticamente.<br>
            <a href="https://liturgia.cancaonova.com/pb/liturgia/?sDia=${day}&sMes=${month}&sAno=${year}" target="_blank" style="color: var(--primary); font-weight: bold;">
                Clique aqui para acessar as leituras no site da Canção Nova
            </a>
        </div><br>
        
        <strong>RITOS INICIAIS</strong><br><br>
        
        <span class="liturgy-role">Sacerdote:</span> Em nome do Pai, do Filho ✠ e do Espírito Santo.<br>
        <span class="liturgy-response">Amém.</span><br><br>
        
        <span class="liturgy-role">Sacerdote:</span> A graça de nosso Senhor Jesus Cristo, o amor do Pai e a comunhão do Espírito Santo estejam convosco.<br>
        <span class="liturgy-response">Bendito seja Deus, que nos reuniu no amor de Cristo!</span><br><br>
        
        <strong>LITURGIA EUCARÍSTICA</strong><br><br>
        
        <span class="liturgy-role">Oração sobre as oferendas:</span> Aceitai, ó Deus, as oferendas que vos apresentamos. Fazei que esta Eucaristia seja para nós fonte de graça e renovação. Por Cristo, nosso Senhor.<br>
        <span class="liturgy-response">Amém.</span><br><br>
        
        <strong>RITOS FINAIS</strong><br><br>
        
        <span class="liturgy-role">Oração após a comunhão:</span> Deus eterno e todo-poderoso, que nos alimentastes com o pão da vida, fazei que nosso coração se encha de vossa graça. Por Cristo, nosso Senhor.<br>
        <span class="liturgy-response">Amém.</span><br><br>
        
        <span class="liturgy-role">Bênção solene:</span> O Deus, que nos reuniu nesta celebração, vos abençoe e guarde. ✠ Amém.<br>
        Que Ele ilumine o vosso caminho e fortaleça vossa fé. ✠ Amém.<br>
        E que todos nós, aqui reunidos, sejamos testemunhas do seu amor. ✠ Amém.<br><br>
        
        <span class="liturgy-role">Sacerdote:</span> E a bênção de Deus todo-poderoso, Pai, Filho e Espírito Santo, desça sobre vós e permaneça para sempre.<br>
        <span class="liturgy-response">Amém.</span><br><br>
        
        <span class="liturgy-role">Sacerdote:</span> Ide em paz, levando a alegria desta celebração!<br>
        <span class="liturgy-response">Graças a Deus!</span>
    `;
    
    // Atualizar título
    const liturgyHeader = document.querySelector('.liturgy-header h2');
    if (liturgyHeader) {
        liturgyHeader.innerHTML = `<i class="fas fa-book-bible liturgy-icon"></i> Liturgia - ${dataFormatada}`;
    }
    
    // Adicionar controles mesmo com erro
    if (day && month && year) {
        addLiturgyControls(day, month, year);
    }
}

// Função para adicionar controles
function addLiturgyControls(day, month, year) {
    const liturgyHeader = document.querySelector('.liturgy-header');
    if (!liturgyHeader) return;
    
    // Remover controles existentes
    const existingControls = liturgyHeader.querySelector('.liturgy-controls');
    if (existingControls) {
        existingControls.remove();
    }
    
    // Criar novos controles
    const controlsDiv = document.createElement('div');
    controlsDiv.className = 'liturgy-controls';
    
    // Botão Hoje
    const todayBtn = document.createElement('button');
    todayBtn.className = 'font-btn';
    todayBtn.innerHTML = '<i class="fas fa-calendar-day"></i> Hoje';
    todayBtn.title = 'Buscar liturgia do dia atual';
    todayBtn.onclick = () => {
        const today = new Date();
        window.location.href = `?dia=${today.getDate()}&mes=${today.getMonth() + 1}&ano=${today.getFullYear()}`;
    };
    
    // Seletor de data
    const dateInput = document.createElement('input');
    dateInput.type = 'date';
    dateInput.value = `${year}-${month.toString().padStart(2, '0')}-${day.toString().padStart(2, '0')}`;
    
    // Botão Buscar
    const goBtn = document.createElement('button');
    goBtn.className = 'font-btn';
    goBtn.innerHTML = '<i class="fas fa-search"></i>';
    goBtn.title = 'Buscar liturgia desta data';
    goBtn.onclick = () => {
        const selectedDate = new Date(dateInput.value);
        window.location.href = `?dia=${selectedDate.getDate()}&mes=${selectedDate.getMonth() + 1}&ano=${selectedDate.getFullYear()}`;
    };
    
    // Botão Recarregar
    const reloadBtn = document.createElement('button');
    reloadBtn.className = 'font-btn';
    reloadBtn.innerHTML = '<i class="fas fa-sync-alt"></i>';
    reloadBtn.title = 'Recarregar liturgia';
    reloadBtn.onclick = () => {
        reloadBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        setTimeout(() => {
            fetchLiturgia();
            reloadBtn.innerHTML = '<i class="fas fa-sync-alt"></i>';
        }, 500);
    };
    
    // Montar controles
    controlsDiv.appendChild(todayBtn);
    controlsDiv.appendChild(dateInput);
    controlsDiv.appendChild(goBtn);
    controlsDiv.appendChild(reloadBtn);
    
    // Inserir após o título
    const titleDiv = liturgyHeader.querySelector('h2');
    if (titleDiv) {
        titleDiv.parentNode.insertBefore(controlsDiv, titleDiv.nextSibling);
    }
}

// Inicialização
document.addEventListener('DOMContentLoaded', function() {
    // Executar funções existentes
    createLiturgyLinks();
    renderMusicList();
    setupLiturgyExpansion();
    
    // Adicionar eventos aos botões
    document.getElementById('increase-font').addEventListener('click', increaseFontSize);
    document.getElementById('decrease-font').addEventListener('click', decreaseFontSize);
    document.getElementById('reset-font').addEventListener('click', resetFontSize);
    
    document.getElementById('expand-all').addEventListener('click', expandAll);
    document.getElementById('collapse-all').addEventListener('click', collapseAll);
    
    setupSearch();
    
    // Buscar liturgia
    setTimeout(() => {
        fetchLiturgia();
    }, 100);
});